#!/usr/bin/env escript
%% -*- erlang -*-
%%! -pa ebin

main(_) ->
    ok = application:start(inets),
    net_kernel:start([pub@localhost]),
    auth:set_cookie(node(), pub),

    ok = application:start(pubsubpoll),
    random:seed(),
    Client = 10000, % Number of clients
    Message = 100, % Number of messages
    psp_count:start_link(Client * Message),
    {ok, _ChanA} = pubsubpoll:create_channel(chan_a, {name, "Robert"}),
    clients(Client),
    flood(Message),
    timer:sleep(100000). % Arbitrary wait

%% Publish lots of dummy messages
flood(0) ->
    ok;
flood(Cpt) ->
    ok = pubsubpoll:publish([{name, "Robert"}, {flavor, "Strawberry"}]),
    timer:sleep(random:uniform(200)),
    flood(Cpt -1).

%% Create lots of clients
clients(Cpt) ->
    clients(Cpt, []).
clients(0, Clients) ->
    {ok, Clients};
clients(Cpt, Clients) ->
    {ok, ClientPid} = pubsubpoll:create_client(),
    pubsubpoll:suscribe(ClientPid, chan_a),
    spawn(fun() ->
        infinite_poll(ClientPid)
    end),
    clients(Cpt-1, [ClientPid | Clients]).

%% poll, wait 10 seconds and poll again and again
infinite_poll(ClientPid) ->
    {ok, Events} = psp_client:poll(ClientPid),
    timer:sleep(random:uniform(10000)),
    infinite_poll(ClientPid).